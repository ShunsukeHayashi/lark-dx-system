name: 'Lark Base Builder with Claude Chain'

on:
  workflow_dispatch:
    inputs:
      industry:
        description: 'å¯¾è±¡ã®æ¥­ç•Œ (ä¾‹: å°å£²æ¥­, è£½é€ æ¥­)'
        required: true
        default: 'ã‚µãƒ³ãƒ—ãƒ«æ¥­ç•Œ'
      business_domain:
        description: 'å¯¾è±¡ã®æ¥­å‹™é ˜åŸŸ (ä¾‹: é¡§å®¢ç®¡ç†, åœ¨åº«ç®¡ç†)'
        required: true
        default: 'ã‚µãƒ³ãƒ—ãƒ«æ¥­å‹™'
      claude_model:
        description: 'Claudeãƒ¢ãƒ‡ãƒ«'
        required: false
        default: 'claude-3-haiku-20240307'
        type: choice
        options:
          - claude-3-haiku-20240307
          - claude-3-sonnet-20240229
          - claude-3-opus-20240229
      auth_method:
        description: 'èªè¨¼æ–¹æ³•'
        required: false
        default: 'api_key'
        type: choice
        options:
          - api_key
          - oauth_token

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-with-claude-chain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install requests pyyaml jinja2

      - name: Create directories
        run: |
          mkdir -p docs/projects
          mkdir -p docs/assets/css
          mkdir -p generated

      - name: Generate Claude Chain Script
        run: |
          cat > claude_chain_generator.py << 'EOF'
          import os
          import json
          import requests
          import yaml
          import time
          from pathlib import Path
          from datetime import datetime
          
          # Configuration
          auth_method = os.environ.get('AUTH_METHOD', 'api_key')
          api_key = os.environ.get('ANTHROPIC_API_KEY')
          oauth_token = os.environ.get('CLAUDE_CODE_OAUTH_TOKEN')
          model = os.environ.get('CLAUDE_MODEL', 'claude-3-haiku-20240307')
          industry = os.environ.get('INDUSTRY')
          business_domain = os.environ.get('BUSINESS_DOMAIN')
          
          # Setup headers based on auth method
          headers = {
              'Content-Type': 'application/json',
              'anthropic-version': '2023-06-01'
          }
          
          if auth_method == 'oauth_token' and oauth_token:
              headers['Authorization'] = f'Bearer {oauth_token}'
          elif api_key:
              headers['x-api-key'] = api_key
          else:
              raise ValueError("No authentication method configured")
          
          # Context accumulator for chain prompting
          context = {
              'industry': industry,
              'business_domain': business_domain,
              'generated_files': {},
              'execution_log': []
          }
          
          def call_claude(prompt, max_tokens=4000):
              """Call Claude API with the given prompt"""
              data = {
                  'model': model,
                  'messages': [{'role': 'user', 'content': prompt}],
                  'max_tokens': max_tokens
              }
              
              try:
                  response = requests.post(
                      'https://api.anthropic.com/v1/messages',
                      headers=headers,
                      json=data
                  )
                  
                  if response.status_code == 200:
                      result = response.json()
                      return result['content'][0]['text']
                  else:
                      error_msg = f"Error: {response.status_code} - {response.text}"
                      print(error_msg)
                      context['execution_log'].append({'error': error_msg, 'timestamp': datetime.now().isoformat()})
                      return None
              except Exception as e:
                  error_msg = f"Exception: {str(e)}"
                  print(error_msg)
                  context['execution_log'].append({'error': error_msg, 'timestamp': datetime.now().isoformat()})
                  return None
          
          def save_output(filename, content):
              """Save output to file and update context"""
              Path('generated').mkdir(exist_ok=True)
              with open(f'generated/{filename}', 'w', encoding='utf-8') as f:
                  f.write(content)
              context['generated_files'][filename] = content
              log_entry = {
                  'action': 'file_created',
                  'filename': filename,
                  'timestamp': datetime.now().isoformat()
              }
              context['execution_log'].append(log_entry)
              print(f"âœ“ Generated: {filename}")
          
          def build_context_summary():
              """Build a summary of the context for the next prompt"""
              summary = f"""
              # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒãƒªãƒ¼
              - æ¥­ç•Œ: {industry}
              - æ¥­å‹™é ˜åŸŸ: {business_domain}
              - ç”Ÿæˆæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«: {', '.join(context['generated_files'].keys())}
              """
              return summary
          
          # ===== C1: System Analysis & Design =====
          print("\n=== C1: System Analysis & Design ===")
          
          # T1: Requirement Definition
          prompt_c1_t1 = f"""
          ã‚ãªãŸã¯Lark Baseã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®è¦ä»¶å®šç¾©ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          
          # å…¥åŠ›æƒ…å ±
          - æ¥­ç•Œ: {industry}
          - æ¥­å‹™é ˜åŸŸ: {business_domain}
          
          ä»¥ä¸‹ã®é …ç›®ã‚’å…·ä½“çš„ã«å®šç¾©ã—ã€YAMLå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
          - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å: {industry}{business_domain}çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
          - ä¸»è¦æ¥­å‹™: æ¥­ç•Œã¨æ¥­å‹™é ˜åŸŸã«å¿œã˜ãŸ3ã¤ä»¥ä¸Šã®å…·ä½“çš„ãªæ¥­å‹™
          - åˆ©ç”¨è€…æ•°: 50-200åï¼ˆæƒ³å®šï¼‰
          - ç®¡ç†å¯¾è±¡æ•°: åˆæœŸ1000ä»¶+å¹´20%å¢—åŠ è¦‹è¾¼ã¿
          - å–å¼•å…ˆæ•°: æ¥­ç•Œç‰¹æ€§ã«å¿œã˜ãŸæ¦‚ç®—
          - ãƒãƒ£ãƒãƒ«æ•°: æ¥­å‹™ç‰¹æ€§ã«å¿œã˜ãŸæ¦‚ç®—
          - æœˆé–“å‡¦ç†ä»¶æ•°: æ¥­å‹™é‡ã«å¿œã˜ãŸæ¦‚ç®—
          
          å‡ºåŠ›å½¢å¼: requirement_spec.yaml ã®å†…å®¹ã¨ã—ã¦å‡ºåŠ›
          """
          
          result = call_claude(prompt_c1_t1)
          if result:
              save_output('requirement_spec.yaml', result)
              time.sleep(1)
          
          # T2: Data Structure Design
          prompt_c1_t2 = f"""
          {build_context_summary()}
          
          å‰ã®ã‚¿ã‚¹ã‚¯ã§ä»¥ä¸‹ã®è¦ä»¶å®šç¾©ã‚’ä½œæˆã—ã¾ã—ãŸï¼š
          ```yaml
          {context['generated_files'].get('requirement_spec.yaml', '')[:1000]}
          ```
          
          ã“ã®è¦ä»¶ã«åŸºã¥ã„ã¦ã€Lark Baseã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚
          
          ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’è¨­è¨ˆã—ã¦YAMLå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
          1. ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé™çš„ãƒ‡ãƒ¼ã‚¿ï¼‰
             - {industry}ã«é–¢é€£ã™ã‚‹å•†å“/ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¹ã‚¿
             - å–å¼•å…ˆãƒã‚¹ã‚¿
             - ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿
             - ãã®ä»–æ¥­ç•Œç‰¹æœ‰ã®ãƒã‚¹ã‚¿
          2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‹•çš„ãƒ‡ãƒ¼ã‚¿ï¼‰
             - {business_domain}ã«é–¢é€£ã™ã‚‹æ³¨æ–‡/ä¾é ¼ãƒ†ãƒ¼ãƒ–ãƒ«
             - å‡¦ç†/ä½œæ¥­ãƒ†ãƒ¼ãƒ–ãƒ«
             - å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
          3. é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
             - åˆ†æç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
             - è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«
             
          å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ä»¥ä¸‹ã‚’å«ã‚ã¦ãã ã•ã„ï¼š
          - table_id: tbl_ã§å§‹ã¾ã‚‹è‹±èªID
          - table_name: æ—¥æœ¬èªå
          - description: èª¬æ˜
          - primary_key: ä¸»ã‚­ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
          - fields_count: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ã®æ¦‚ç®—
             
          å‡ºåŠ›å½¢å¼: table_design.yaml ã®å†…å®¹ã¨ã—ã¦å‡ºåŠ›
          """
          
          result = call_claude(prompt_c1_t2)
          if result:
              save_output('table_design.yaml', result)
              time.sleep(1)
          
          # ===== C2: Field Implementation =====
          print("\n=== C2: Field Implementation ===")
          
          # T0: Primary Key Setup
          prompt_c2_t0 = f"""
          {build_context_summary()}
          
          å‰ã®ã‚¿ã‚¹ã‚¯ã§ä½œæˆã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆï¼š
          ```yaml
          {context['generated_files'].get('table_design.yaml', '')[:1500]}
          ```
          
          å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ï¼š
          
          1. ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼è¨­å®š
             - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¿œã˜ãŸåå‰ï¼ˆä¾‹ï¼šå•†å“IDã€å–å¼•å…ˆã‚³ãƒ¼ãƒ‰ï¼‰
             - ã‚¿ã‚¤ãƒ—: ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç›´æ¥å…¥åŠ›ï¼‰
             - ä½ç½®: æœ€å·¦ç«¯
             - åˆ¶ç´„: å¿…é ˆã€ãƒ¦ãƒ‹ãƒ¼ã‚¯
             - å½¢å¼ä¾‹: "PRD-00001", "CUST-00001"
             
          2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼è¨­å®š
             - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: å„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸåå‰ï¼ˆä¾‹ï¼šæ³¨æ–‡IDã€ä½œæ¥­IDï¼‰
             - ã‚¿ã‚¤ãƒ—: æ•°å¼
             - æ•°å¼ãƒ‘ã‚¿ãƒ¼ãƒ³: CONCATENATE(TEXT(æ—¥ä»˜, "YYYY-MM-DD"), "_", é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£, "_", LEFT(èª¬æ˜, 20))
             - ä½ç½®: æœ€å·¦ç«¯
             - è¡¨ç¤ºä¾‹: "2024-01-15_ABCå•†äº‹_å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å®Ÿæ–½"
             
          3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š
             - å„ãƒªãƒ³ã‚¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§è¡¨ç¤ºã™ã‚‹æƒ…å ±ã‚’3ã¤ã¾ã§é¸æŠ
             - å„ªå…ˆé †ä½: ID > ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ > é‡‘é¡/æ•°é‡
             
          å‡ºåŠ›å½¢å¼: primary_key_design.json ã®å†…å®¹ã¨ã—ã¦å‡ºåŠ›ï¼ˆJSONå½¢å¼ï¼‰
          """
          
          result = call_claude(prompt_c2_t0)
          if result:
              save_output('primary_key_design.json', result)
              time.sleep(1)
          
          # T1: Master Fields
          prompt_c2_t1 = f"""
          {build_context_summary()}
          
          ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã¨ä¸»ã‚­ãƒ¼è¨­è¨ˆã«åŸºã¥ã„ã¦ã€ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è©³ç´°è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚
          
          å„ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆï¼š
          - IDï¼ˆãƒ†ã‚­ã‚¹ãƒˆ/è‡ªå‹•æ¡ç•ªï¼‰: ä¸»ã‚­ãƒ¼è¨­è¨ˆã«å¾“ã†
          - åç§°ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å
          - ã‚«ãƒ†ã‚´ãƒªï¼ˆå˜ä¸€é¸æŠï¼‰: 
            - {industry}ã«å¿œã˜ãŸé¸æŠè‚¢ã‚’3-5å€‹
            - è‰²: æ¨™æº–è‰²ãƒ‘ãƒ¬ãƒƒãƒˆä½¿ç”¨ï¼ˆ1è¡Œç›®ã®è‰²ï¼‰
          - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå˜ä¸€é¸æŠï¼‰:
            - æœ‰åŠ¹: ğŸŸ¢ç·‘ï¼ˆ1è¡Œç›®5ç•ªç›®ï¼‰
            - ç„¡åŠ¹: ğŸ¤ã‚°ãƒ¬ãƒ¼ï¼ˆ1è¡Œç›®11ç•ªç›®ï¼‰
          - æ•°å€¤ãƒ‡ãƒ¼ã‚¿ï¼ˆæ•°å€¤/é€šè²¨ï¼‰: å˜ä¾¡ã€åœ¨åº«æ•°ãªã©
          - æ—¥ä»˜ï¼ˆæ—¥ä»˜ï¼‰: ç™»éŒ²æ—¥ã€æ›´æ–°æ—¥
          - æ‹…å½“è€…ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰: å˜ä¸€é¸æŠ
          - å‚™è€ƒï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰: è¤‡æ•°è¡Œ
          - {industry}å›ºæœ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: æ¥­ç•Œç‰¹æ€§ã«å¿œã˜ãŸè¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          
          å‡ºåŠ›å½¢å¼: master_fields.json ã®å†…å®¹ã¨ã—ã¦å‡ºåŠ›ï¼ˆJSONå½¢å¼ï¼‰
          """
          
          result = call_claude(prompt_c2_t1)
          if result:
              save_output('master_fields.json', result)
              time.sleep(1)
          
          # T2: Transaction Fields
          prompt_c2_t2 = f"""
          {build_context_summary()}
          
          ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è©³ç´°è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚
          
          å„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆï¼š
          - å‡¦ç†ç•ªå·ï¼ˆè‡ªå‹•æ¡ç•ªï¼‰: ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹-YYYYMMDD-0001å½¢å¼
          - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå˜ä¸€é¸æŠï¼‰:
            - æ–°è¦: ğŸ”µé’
            - å‡¦ç†ä¸­: ğŸŸ¡é»„
            - å®Œäº†: ğŸŸ¢ç·‘
            - ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ğŸ¤ã‚°ãƒ¬ãƒ¼
            - ã‚¨ãƒ©ãƒ¼: â¤ï¸èµ¤
          - å„ªå…ˆåº¦ï¼ˆå˜ä¸€é¸æŠï¼‰:
            - ç·Šæ€¥: â¤ï¸èµ¤
            - é«˜: ğŸŸ¡é»„
            - ä¸­: ğŸ”µé’
            - ä½: ğŸ¤ã‚°ãƒ¬ãƒ¼
          - é‡‘é¡é–¢é€£ï¼ˆé€šè²¨ï¼‰: é‡‘é¡ã€ç¨é¡ã€åˆè¨ˆ
          - æœŸæ—¥ï¼ˆæ—¥ä»˜ï¼‰: é–‹å§‹æ—¥ã€æœŸé™ã€å®Œäº†æ—¥
          - ãƒ•ãƒ©ã‚°ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰: ç·Šæ€¥ãƒ•ãƒ©ã‚°ã€æ‰¿èªãƒ•ãƒ©ã‚°
          - ãƒªãƒ³ã‚¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å‚ç…§
          - {business_domain}å›ºæœ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: æ¥­å‹™ç‰¹æ€§ã«å¿œã˜ãŸè¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          
          å‡ºåŠ›å½¢å¼: transaction_fields.json ã®å†…å®¹ã¨ã—ã¦å‡ºåŠ›ï¼ˆJSONå½¢å¼ï¼‰
          """
          
          result = call_claude(prompt_c2_t2)
          if result:
              save_output('transaction_fields.json', result)
              time.sleep(1)
          
          # T3: Formula Fields
          prompt_c2_t3 = f"""
          {build_context_summary()}
          
          æ•°å¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚{industry}ã¨{business_domain}ã®ç‰¹æ€§ã‚’è€ƒæ…®ã—ã¦é©åˆ‡ãªè¨ˆç®—å¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          
          ä»¥ä¸‹ã®æ•°å¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆï¼š
          1. æ®‹æ—¥æ•°è¨ˆç®—:
             IF(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ != "å®Œäº†", æœŸé™ - TODAY(), "å®Œäº†æ¸ˆ")
          2. åœ¨åº«äºˆæ¸¬ï¼ˆå•†å“ç³»ã®å ´åˆï¼‰:
             IF(åœ¨åº« / æ—¥æ¬¡å¹³å‡ < 7, "ğŸš¨ç·Šæ€¥ç™ºæ³¨",
             IF(åœ¨åº« / æ—¥æ¬¡å¹³å‡ < 14, "âš ï¸è¦ç¢ºèª", "âœ…æ­£å¸¸"))
          3. é”æˆç‡:
             IF(ç›®æ¨™ > 0, å®Ÿç¸¾ / ç›®æ¨™ * 100, 0)
          4. ã‚¢ãƒ©ãƒ¼ãƒˆåˆ¤å®š:
             IF(æ®‹æ—¥æ•° < 0, "é…å»¶",
             IF(æ®‹æ—¥æ•° < 3, "æœŸé™é–“è¿‘", "æ­£å¸¸"))
          5. {industry}å›ºæœ‰ã®è¨ˆç®—å¼:
             æ¥­ç•Œç‰¹æ€§ã«å¿œã˜ãŸç‹¬è‡ªã®è¨ˆç®—å¼ã‚’3ã¤ä»¥ä¸Š
          
          å‡ºåŠ›å½¢å¼: formula_fields.json ã®å†…å®¹ã¨ã—ã¦å‡ºåŠ›ï¼ˆJSONå½¢å¼ï¼‰
          """
          
          result = call_claude(prompt_c2_t3)
          if result:
              save_output('formula_fields.json', result)
              time.sleep(1)
          
          # ===== C3: Relation Setup =====
          print("\n=== C3: Relation Setup ===")
          
          # T0: Visibility Check
          prompt_c3_t0 = f"""
          {build_context_summary()}
          
          ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šå¾Œã®å¯è¦–æ€§æœ€é©åŒ–è¨­è¨ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
          
          1. åŒæ–¹å‘ãƒªãƒ³ã‚¯ã®è¡¨ç¤ºç¢ºèª
             - è¦ªãƒ†ãƒ¼ãƒ–ãƒ«å´: é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã®è¡¨ç¤º
             - å­ãƒ†ãƒ¼ãƒ–ãƒ«å´: è¦ªãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä¸»è¦æƒ…å ±è¡¨ç¤º
          2. ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 
             - å–å¼•å…ˆã‹ã‚‰: æœ€çµ‚å–å¼•æ—¥ã€ç´¯è¨ˆé‡‘é¡
             - å•†å“ã‹ã‚‰: åœ¨åº«æ•°ã€å˜ä¾¡
             - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰: é€²æ—ç‡ã€æœŸé™
          3. ãƒªãƒ³ã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æœ€é©åŒ–
             - è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°: 3
             - è¡¨ç¤ºé †åºã®èª¿æ•´
          
          å‡ºåŠ›å½¢å¼: visibility_optimization.json ã®å†…å®¹ã¨ã—ã¦å‡ºåŠ›ï¼ˆJSONå½¢å¼ï¼‰
          """
          
          result = call_claude(prompt_c3_t0)
          if result:
              save_output('visibility_optimization.json', result)
              time.sleep(1)
          
          # Continue with C3-T1, T2, T3...
          # C4: Workflow Automation
          # C5: Button Implementation
          # C6: View Creation
          # C7: Dashboard Creation
          # C8: Permission Setup
          # C9: Testing & Validation
          # C10: Deployment
          
          # Save final context
          context['completion_time'] = datetime.now().isoformat()
          context['total_files_generated'] = len(context['generated_files'])
          
          with open('generated/execution_context.json', 'w', encoding='utf-8') as f:
              json.dump({
                  'project_id': f"{industry}-{business_domain}-{time.strftime('%Y%m%d%H%M%S')}",
                  'industry': industry,
                  'business_domain': business_domain,
                  'model': model,
                  'auth_method': auth_method,
                  'generated_files': list(context['generated_files'].keys()),
                  'execution_log': context['execution_log'],
                  'completion_time': context['completion_time']
              }, f, ensure_ascii=False, indent=2)
          
          print("\nâœ… Chain prompting completed!")
          print(f"Total files generated: {context['total_files_generated']}")
          print(f"Generated files: {', '.join(context['generated_files'].keys())}")
          EOF

      - name: Execute Claude Chain Prompting
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          AUTH_METHOD: ${{ github.event.inputs.auth_method }}
          CLAUDE_MODEL: ${{ github.event.inputs.claude_model }}
          INDUSTRY: ${{ github.event.inputs.industry }}
          BUSINESS_DOMAIN: ${{ github.event.inputs.business_domain }}
        run: |
          python claude_chain_generator.py

      - name: Generate HTML Documentation
        run: |
          PROJECT_ID="${{ github.event.inputs.industry }}-${{ github.event.inputs.business_domain }}-$(date +%Y%m%d%H%M%S)"
          PROJECT_DIR="docs/projects/${PROJECT_ID}"
          mkdir -p ${PROJECT_DIR}
          
          # Copy generated files
          cp generated/*.yaml ${PROJECT_DIR}/ 2>/dev/null || true
          cp generated/*.json ${PROJECT_DIR}/ 2>/dev/null || true
          
          # Generate CSS
          cat > docs/assets/css/style.css << 'EOF'
          :root {
            --primary-color: #1a73e8;
            --secondary-color: #34a853;
            --background-color: #f8f9fa;
            --text-color: #202124;
            --border-color: #dadce0;
          }
          
          * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
          }
          
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
          }
          
          .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
          }
          
          header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px 0;
            margin-bottom: 30px;
          }
          
          h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 10px;
          }
          
          .project-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          .section {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          
          .section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
          }
          
          .download-section {
            background: var(--secondary-color);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 30px 0;
          }
          
          .download-btn {
            display: inline-block;
            background: white;
            color: var(--secondary-color);
            padding: 10px 30px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
          }
          
          .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
          }
          
          th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
          }
          
          th {
            background: var(--background-color);
            font-weight: bold;
          }
          
          code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
          }
          
          pre {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
          }
          
          .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
          }
          
          .status-completed {
            background: #e6f4ea;
            color: #137333;
          }
          
          .status-in-progress {
            background: #fef7e0;
            color: #b05a00;
          }
          
          .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
          }
          
          .nav-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
          }
          
          .nav-btn:hover {
            background: #1557b0;
          }
          
          .code-output {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
          }
          
          .file-list {
            list-style: none;
            padding: 0;
          }
          
          .file-list li {
            padding: 10px;
            margin: 5px 0;
            background: var(--background-color);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
          }
          
          .file-icon {
            margin-right: 10px;
          }
          EOF
          
          # Generate project HTML
          cat > ${PROJECT_DIR}/index.html << EOF
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>${{ github.event.inputs.industry }}${{ github.event.inputs.business_domain }}çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - è¨­è¨ˆæ›¸</title>
              <link rel="stylesheet" href="../../assets/css/style.css">
          </head>
          <body>
              <header>
                  <div class="container">
                      <h1>ğŸ¢ ${{ github.event.inputs.industry }}${{ github.event.inputs.business_domain }}çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                      <p>Lark Base è¨­è¨ˆæ›¸ãƒ»å®Ÿè£…ã‚¬ã‚¤ãƒ‰ (Claude Chain Generated)</p>
                  </div>
              </header>
              
              <div class="container">
                  <div class="project-info">
                      <h2>ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</h2>
                      <table>
                          <tr>
                              <th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID</th>
                              <td><code>${PROJECT_ID}</code></td>
                          </tr>
                          <tr>
                              <th>æ¥­ç•Œ</th>
                              <td>${{ github.event.inputs.industry }}</td>
                          </tr>
                          <tr>
                              <th>æ¥­å‹™é ˜åŸŸ</th>
                              <td>${{ github.event.inputs.business_domain }}</td>
                          </tr>
                          <tr>
                              <th>ç”Ÿæˆæ—¥æ™‚</th>
                              <td>$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')</td>
                          </tr>
                          <tr>
                              <th>Claudeãƒ¢ãƒ‡ãƒ«</th>
                              <td>${{ github.event.inputs.claude_model }}</td>
                          </tr>
                          <tr>
                              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                              <td><span class="status-badge status-completed">ç”Ÿæˆå®Œäº†</span></td>
                          </tr>
                      </table>
                  </div>
                  
                  <div class="download-section">
                      <h2>ğŸ“¥ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
                      <p>Claude Chainã«ã‚ˆã‚Šç”Ÿæˆã•ã‚ŒãŸè¨­è¨ˆæ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</p>
          EOF
          
          # Add download links for generated files
          for file in generated/*.yaml generated/*.json; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "            <a href=\"$filename\" class=\"download-btn\" download>$filename</a>" >> ${PROJECT_DIR}/index.html
            fi
          done
          
          cat >> ${PROJECT_DIR}/index.html << EOF
                  </div>
                  
                  <div class="section">
                      <h2>ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦</h2>
                      <p>${{ github.event.inputs.industry }}ã«ãŠã‘ã‚‹${{ github.event.inputs.business_domain }}æ¥­å‹™ã‚’åŠ¹ç‡åŒ–ã™ã‚‹ãŸã‚ã®çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚</p>
                      
                      <h3>Claude Chainå®Ÿè¡Œå†…å®¹</h3>
                      <ul class="file-list">
                          <li><span class="file-icon">ğŸ“„</span> C1-T1: è¦ä»¶å®šç¾© (requirement_spec.yaml)</li>
                          <li><span class="file-icon">ğŸ“„</span> C1-T2: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ (table_design.yaml)</li>
                          <li><span class="file-icon">ğŸ“„</span> C2-T0: ä¸»ã‚­ãƒ¼è¨­è¨ˆ (primary_key_design.json)</li>
                          <li><span class="file-icon">ğŸ“„</span> C2-T1: ãƒã‚¹ã‚¿ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­è¨ˆ (master_fields.json)</li>
                          <li><span class="file-icon">ğŸ“„</span> C2-T2: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­è¨ˆ (transaction_fields.json)</li>
                          <li><span class="file-icon">ğŸ“„</span> C2-T3: æ•°å¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­è¨ˆ (formula_fields.json)</li>
                          <li><span class="file-icon">ğŸ“„</span> C3-T0: å¯è¦–æ€§æœ€é©åŒ–è¨­è¨ˆ (visibility_optimization.json)</li>
                      </ul>
                  </div>
                  
                  <div class="section">
                      <h2>ğŸ”— å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ</h2>
                      <p>Claude Chainå®Ÿè¡Œæ™‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ç”Ÿæˆãƒ­ã‚°</p>
                      <div class="code-output">
                          <pre id="execution-context"></pre>
                      </div>
                  </div>
                  
                  <div class="nav-buttons">
                      <a href="../../index.html" class="nav-btn">â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¸</a>
                  </div>
              </div>
              
              <script>
                  // Load and display execution context
                  fetch('execution_context.json')
                      .then(response => response.json())
                      .then(data => {
                          document.getElementById('execution-context').textContent = JSON.stringify(data, null, 2);
                      })
                      .catch(error => {
                          document.getElementById('execution-context').textContent = 'Context file not found';
                      });
              </script>
          </body>
          </html>
          EOF
          
          # Create index page
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Lark Base è¨­è¨ˆæ›¸ãƒãƒ¼ã‚¿ãƒ«</title>
              <link rel="stylesheet" href="assets/css/style.css">
          </head>
          <body>
              <header>
                  <div class="container">
                      <h1>ğŸ—‚ï¸ Lark Base è¨­è¨ˆæ›¸ãƒãƒ¼ã‚¿ãƒ«</h1>
                      <p>Claude Chainã§ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€è¦§</p>
                  </div>
              </header>
              <div class="container">
                  <div class="section">
                      <h2>ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h2>
                      <div id="project-list">
                          <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>ğŸš€ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
                      <p>GitHub Actions ã® workflow_dispatch ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚</p>
                      <ol>
                          <li>GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Actions ã‚¿ãƒ–ã‚’é–‹ã</li>
                          <li>"Lark Base Builder with Claude Chain" ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é¸æŠ</li>
                          <li>"Run workflow" ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                          <li>æ¥­ç•Œã¨æ¥­å‹™é ˜åŸŸã‚’å…¥åŠ›</li>
                          <li>èªè¨¼æ–¹æ³•ã‚’é¸æŠï¼ˆAPI Key ã¾ãŸã¯ OAuth Tokenï¼‰</li>
                          <li>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ</li>
                      </ol>
                  </div>
              </div>
              
              <script>
                  // Simple project listing
                  const projectList = document.getElementById('project-list');
                  projectList.innerHTML = '<ul class="file-list">';
                  
                  // This would normally fetch from an API or directory listing
                  // For now, just show the current project
                  const currentProject = {
                      id: '${{ github.event.inputs.industry }}-${{ github.event.inputs.business_domain }}',
                      url: 'projects/${PROJECT_ID}/',
                      date: new Date().toLocaleDateString('ja-JP')
                  };
                  
                  projectList.innerHTML += \`
                      <li>
                          <span class="file-icon">ğŸ“</span>
                          <a href="\${currentProject.url}">\${currentProject.id}</a>
                          <span>\${currentProject.date}</span>
                      </li>
                  \`;
                  
                  projectList.innerHTML += '</ul>';
              </script>
          </body>
          </html>
          EOF

      - name: Commit to GitHub Pages branch
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # Create or checkout gh-pages branch
          git checkout -B gh-pages || git checkout gh-pages
          
          # Copy docs content
          cp -r docs/* .
          
          git add .
          git commit -m "Add Claude Chain generated docs for ${{ github.event.inputs.industry }}-${{ github.event.inputs.business_domain }}" || echo "No changes to commit"
          git push origin gh-pages --force

      - name: Enable GitHub Pages
        run: |
          # Enable GitHub Pages via API
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pages \
            -d '{"source":{"branch":"gh-pages","path":"/"}}' || echo "Pages might already be enabled"

      - name: Output Pages URL
        run: |
          echo "ğŸ“„ è¨­è¨ˆæ›¸ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼"
          echo "URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/projects/"
          echo ""
          echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la generated/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lark-base-claude-chain-${{ github.run_number }}
          path: |
            generated/
            docs/
          retention-days: 30